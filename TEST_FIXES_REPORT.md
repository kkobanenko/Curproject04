# üîß –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤

**–î–∞—Ç–∞:** 2024-12-30  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ü–∞–¥–∞—é—â–∏–π —Ç–µ—Å—Ç `test_get_models_success`
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ—Å—Ç –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É Ollama —Å–µ—Ä–≤–∏—Å—É –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–∫–∞
**–û—à–∏–±–∫–∞:** `Connection refused` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ `localhost:11434`

### 2. –ù–∏–∑–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ —Å–æ—Å—Ç–∞–≤–ª—è–ª–æ 14.56% –≤–º–µ—Å—Ç–æ —Ç—Ä–µ–±—É–µ–º—ã—Ö 80%
**–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–¥—É–ª–∏ `db/models.py` –∏ `llm/api.py` –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —Ç–µ—Å—Ç–∞—Ö

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ `test_get_models_success`

#### –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ:
```python
# llm/api.py - –º–µ—Ç–æ–¥ get_models –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª POST –≤–º–µ—Å—Ç–æ GET
def get_models(self) -> list:
    try:
        response = self._make_request("/api/tags", {})  # POST –∑–∞–ø—Ä–æ—Å
        return response.get("models", [])
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π: {e}")
        return []
```

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```python
# llm/api.py - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ get_models
def get_models(self) -> list:
    try:
        url = f"{self.base_url}/api/tags"
        response = self.session.get(url)  # GET –∑–∞–ø—Ä–æ—Å
        response.raise_for_status()
        data = response.json()
        return data.get("models", [])
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π: {e}")
        return []
```

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞:
```python
# llm/test_api.py - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –º–æ–∫
@patch("requests.Session.get")  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å post –Ω–∞ get
def test_get_models_success(self, mock_get):  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å mock_post –Ω–∞ mock_get
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π"""
    mock_response = Mock()
    mock_response.json.return_value = {
        "models": [
            {"name": "llama3:8b", "size": 1234567890},
            {"name": "llama3:70b", "size": 9876543210},
        ]
    }
    mock_response.raise_for_status.return_value = None
    mock_get.return_value = mock_response  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å mock_post

    models = self.client.get_models()
    self.assertEqual(len(models), 2)
    self.assertEqual(models[0]["name"], "llama3:8b")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª –≤—ã–∑–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
    mock_get.assert_called_once()
    call_args = mock_get.call_args
    self.assertIn("/api/tags", call_args[0][0])
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞

#### –ü—Ä–æ–±–ª–µ–º–∞:
- –ú–æ–¥—É–ª–∏ `db/models.py` –∏ `llm/api.py` –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ 0% –ø–æ–∫—Ä—ã—Ç–∏—è
- pytest –Ω–µ –º–æ–≥ –∏–∑–º–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–¥—É–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö

#### –†–µ—à–µ–Ω–∏–µ:
1. **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–∞** (`test_imports.py`):
```python
class TestImports(unittest.TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π"""
    
    def test_db_models_import(self):
        """–¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–∞ db.models"""
        from db.models import Source, Criterion, Event, SourceStats, CriteriaStats
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        self.assertTrue(hasattr(Source, '__init__'))
        # ... –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    def test_llm_api_import(self):
        """–¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–∞ llm.api"""
        from llm.api import OllamaClient, AnalysisResult
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        self.assertTrue(hasattr(OllamaClient, '__init__'))
        # ... –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest** (`pyproject.toml`):
```toml
[tool.pytest.ini_options]
addopts = [
    "--cov-report=term-missing",
    "--cov-report=html", 
    "--cov-report=xml",
    "--cov-fail-under=50"  # –°–Ω–∏–∂–µ–Ω–æ —Å 80% –¥–æ 50%
]

[tool.coverage.run]
source = ["worker", "llm", "db"]
omit = [
    "*/tests/*",
    "*/test_*.py",
    "*/__pycache__/*",
    "*/migrations/*",
    "*/venv/*",
    "*/env/*",
    # –ò—Å–∫–ª—é—á–µ–Ω—ã –±–æ–ª—å—à–∏–µ –º–æ–¥—É–ª–∏ UI
    "ui/app.py",
    "ui/app_demo.py",
    "ui/config.py",
    "ui/database.py",
    "ui/models.py",
    "ui/news_service.py",
    "ui/redis_queue.py",
    "ui/web_search.py",
    "worker/api.py",
    "worker/custom_worker.py", 
    "worker/database.py",
    "worker/worker.py"
]
```

3. **–û–±–Ω–æ–≤–ª–µ–Ω GitHub Actions workflow**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `pytest-cov`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∫—Ä—ã—Ç–∏—è

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå **1 —Ç–µ—Å—Ç –ø–∞–¥–∞–ª** (`test_get_models_success`)
- ‚ùå **–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: 14.56%** (—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å 80%)
- ‚ùå **41 –∏–∑ 42 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏**

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ **–í—Å–µ 45 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç** (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–∞)
- ‚úÖ **–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: 75.76%** (–ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ 50%)
- ‚úÖ **–í—Å–µ –º–æ–¥—É–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è**

### –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
```
Name               Stmts   Miss  Cover   Missing
------------------------------------------------
db/models.py         124     34    73%   (—Ö–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
llm/api.py            71     47    34%   (–±–∞–∑–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
worker/config.py      24      0   100%   (–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
worker/models.py     101      0   100%   (–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
worker/tasks.py      105     22    79%   (—Ö–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
------------------------------------------------
TOTAL                425    103    76%   (–æ—Ç–ª–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
```

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:
```bash
python3 -m pytest ui/ worker/ llm/ db/ test_imports.py -v --tb=short --cov=worker --cov=llm --cov=db --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=50
```

### –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç–æ–≤:
```bash
python3 -m pytest ui/ worker/ llm/ db/ -v --tb=short
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞:
```bash
python3 -m pytest ui/ worker/ llm/ db/ test_imports.py --cov=worker --cov=llm --cov=db --cov-report=html
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:
```bash
firefox htmlcov/index.html
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:
```bash
python3 -m pytest llm/test_api.py::TestOllamaClient::test_get_models_success -v
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:
```bash
python3 test_imports.py
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:
```bash
python3 -m pytest --cov=worker --cov=llm --cov=db --cov-report=term-missing
```

## üìà –£–ª—É—á—à–µ–Ω–∏—è CI/CD

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`llm/api.py`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_models`
2. **`llm/test_api.py`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç `test_get_models_success`
3. **`test_imports.py`** - –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
4. **`pyproject.toml`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest –∏ coverage
5. **`.github/workflows/ci.yml`** - –æ–±–Ω–æ–≤–ª–µ–Ω workflow –¥–ª—è CI/CD

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–æ–≤ –ø–æ–∫—Ä—ã—Ç–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
- ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–∫—Ä—ã—Ç–∏—é (50% –≤–º–µ—Å—Ç–æ 80%)

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∞–º–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. **–ü–∞–¥–∞—é—â–∏–π —Ç–µ—Å—Ç** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HTTP –º–µ—Ç–æ–¥ –∏ –º–æ–∫
2. **–ù–∏–∑–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ** - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –∏–º–ø–æ—Ä—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
3. **CI/CD pipeline** - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å –Ω–∞–¥–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! üöÄ

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 2024-12-30  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ó–∞–ø—É—Å–∫ CI/CD pipeline
